<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Result Manager | Vidya Vikas ERP</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .header-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .class-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
            border-left: 5px solid #dc3545;
        }

        .class-card.published {
            border-left-color: #28a745;
        }

        .class-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .status-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
        }

        .status-unpublished {
            background: #dc3545;
            color: white;
        }

        .status-published {
            background: #28a745;
            color: white;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 30px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: #28a745;
        }

        input:checked+.slider:before {
            transform: translateX(30px);
        }

        .bulk-action-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            color: white;
            font-weight: 700;
            font-size: 16px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s;
        }

        .bulk-action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }

        .stats-box {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            color: white;
        }

        .stats-box h3 {
            font-size: 36px;
            font-weight: 800;
            margin: 0;
        }

        .stats-box p {
            margin: 0;
            font-size: 14px;
        }
    </style>
</head>

<body>
    <div class="container py-4">
        <!-- Header Section -->
        <div class="header-section">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-0"><i class="fas fa-shield-alt text-primary"></i> Result Manager</h2>
                    <p class="text-muted mb-0">Control result publication and student holds</p>
                </div>
                <div>
                    <button class="bulk-action-btn" onclick="bulkPublishAll()">
                        <i class="fas fa-rocket me-2"></i>Publish All Results
                    </button>
                    <a href="/" class="btn btn-outline-secondary ms-2">
                        <i class="fas fa-home"></i> Dashboard
                    </a>
                </div>
            </div>
        </div>

        <!-- Statistics -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="stats-box">
                    <h3 id="totalClasses">0</h3>
                    <p>Total Classes</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-box" style="background: rgba(40, 167, 69, 0.3);">
                    <h3 id="publishedCount">0</h3>
                    <p>Published</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-box" style="background: rgba(220, 53, 69, 0.3);">
                    <h3 id="unpublishedCount">0</h3>
                    <p>Unpublished</p>
                </div>
            </div>
        </div>

        <!-- Classes Grid -->
        <div id="classesContainer" class="row">
            <!-- Classes will be loaded here -->
        </div>

        <!-- Student Hold Management Section -->
        <div class="header-section mt-5">
            <h4 class="mb-3"><i class="fas fa-user-lock text-warning"></i> Student Hold Management</h4>
            <p class="text-muted mb-3">Select a class to manage individual student result holds</p>

            <div class="row">
                <div class="col-md-4 mb-3">
                    <select id="classSelector" class="form-select" onchange="loadStudents(this.value)">
                        <option value="">-- Select Class --</option>
                    </select>
                </div>
            </div>

            <div id="studentsTableContainer" style="display: none;">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Roll No</th>
                                <th>Admission No</th>
                                <th>Student Name</th>
                                <th>Status</th>
                                <th>Hold Result</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTableBody">
                            <!-- Students will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Withhold Reason Modal -->
    <div class="modal fade" id="withholdReasonModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Withhold Reason</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Student:</strong> <span id="withholdStudentName"></span></p>
                    <div class="mb-3">
                        <label for="withholdReason" class="form-label">Reason for Withholding Result</label>
                        <textarea id="withholdReason" class="form-control" rows="3"
                            placeholder="e.g., Fee dues pending"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="saveWithholdReason()">Hold Result</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Action</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modalMessage">
                    Are you sure you want to proceed?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmBtn">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let confirmModal;
        let withholdModal;
        let pendingAction = null;

        document.addEventListener('DOMContentLoaded', function () {
            confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
            withholdModal = new bootstrap.Modal(document.getElementById('withholdReasonModal'));
            loadClasses();
            populateClassSelector();
        });

        async function populateClassSelector() {
            try {
                const response = await fetch('/results/publication-status');
                const classes = await response.json();

                const selector = document.getElementById('classSelector');
                classes.forEach(cls => {
                    const option = document.createElement('option');
                    option.value = cls.class_id;
                    option.textContent = cls.class_name;
                    selector.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading class selector:', error);
            }
        }

        async function loadStudents(classId) {
            if (!classId) {
                document.getElementById('studentsTableContainer').style.display = 'none';
                return;
            }

            try {
                const response = await fetch(`/students/api/filter?class_id=${classId}`);
                const students = await response.json();

                displayStudents(students);
                document.getElementById('studentsTableContainer').style.display = 'block';
            } catch (error) {
                console.error('Error loading students:', error);
                showNotification('Failed to load students', 'error');
            }
        }

        function displayStudents(students) {
            const tbody = document.getElementById('studentsTableBody');
            tbody.innerHTML = '';

            students.forEach(student => {
                const isHeld = student.is_result_withheld || false;
                const statusBadge = isHeld
                    ? '<span class="badge bg-danger">ON HOLD</span>'
                    : '<span class="badge bg-success">Active</span>';

                const toggleChecked = isHeld ? 'checked' : '';

                const row = `
                    <tr>
                        <td>${student.roll_no || '-'}</td>
                        <td>${student.admission_no}</td>
                        <td>${student.student_name}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <label class="toggle-switch">
                                <input type="checkbox" ${toggleChecked} 
                                       onchange="toggleStudentHold(${student.id}, this.checked, '${student.student_name}')">
                                <span class="slider"></span>
                            </label>
                        </td>
                        <td>
                            ${isHeld && student.withhold_reason ?
                        `<small class="text-muted" title="${student.withhold_reason}">
                                    <i class="fas fa-info-circle"></i> ${student.withhold_reason.substring(0, 30)}...
                                </small>` :
                        '-'}
                        </td>
                    </tr>
                `;

                tbody.innerHTML += row;
            });
        }

        let currentStudentId = null;
        let currentStudentName = null;

        function toggleStudentHold(studentId, hold, studentName) {
            currentStudentId = studentId;
            currentStudentName = studentName;

            if (hold) {
                // Show modal to get reason
                document.getElementById('withholdStudentName').textContent = studentName;
                document.getElementById('withholdReason').value = '';
                withholdModal.show();
            } else {
                // Release hold immediately
                executeStudentHold(studentId, false, '');
            }
        }

        async function saveWithholdReason() {
            const reason = document.getElementById('withholdReason').value.trim();

            if (!reason) {
                alert('Please provide a reason for withholding the result');
                return;
            }

            await executeStudentHold(currentStudentId, true, reason);
            withholdModal.hide();
        }

        async function executeStudentHold(studentId, hold, reason) {
            try {
                const response = await fetch(`/students/hold/${studentId}?hold=${hold}&reason=${encodeURIComponent(reason)}`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (response.ok) {
                    const action = hold ? 'held' : 'released';
                    showNotification(`Result ${action} successfully`, 'success');

                    // Reload students to update UI
                    const classId = document.getElementById('classSelector').value;
                    if (classId) {
                        loadStudents(classId);
                    }
                } else {
                    showNotification('Failed to update hold status', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('Network error occurred', 'error');
            }
        }

        async function loadClasses() {
            try {
                const response = await fetch('/results/publication-status');
                const classes = await response.json();

                displayClasses(classes);
                updateStats(classes);
            } catch (error) {
                console.error('Error loading classes:', error);
                alert('Failed to load classes. Please refresh the page.');
            }
        }

        function displayClasses(classes) {
            const container = document.getElementById('classesContainer');
            container.innerHTML = '';

            classes.forEach(cls => {
                const isPublished = cls.is_published;
                const statusClass = isPublished ? 'published' : '';
                const statusBadgeClass = isPublished ? 'status-published' : 'status-unpublished';
                const statusText = isPublished ? 'Published' : 'Unpublished';
                const statusIcon = isPublished ? 'fa-check-circle' : 'fa-lock';

                const card = `
                    <div class="col-md-6 col-lg-4">
                        <div class="class-card ${statusClass}">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div>
                                    <h4 class="mb-1">${cls.class_name}</h4>
                                    <small class="text-muted">
                                        <i class="fas fa-users"></i> ${cls.student_count} Students
                                    </small>
                                </div>
                                <span class="status-badge ${statusBadgeClass}">
                                    <i class="fas ${statusIcon}"></i> ${statusText}
                                </span>
                            </div>
                            
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fw-bold">Publication Status:</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" ${isPublished ? 'checked' : ''} 
                                           onchange="togglePublication(${cls.class_id}, this.checked, '${cls.class_name}')">
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                `;

                container.innerHTML += card;
            });
        }

        function updateStats(classes) {
            const total = classes.length;
            const published = classes.filter(c => c.is_published).length;
            const unpublished = total - published;

            document.getElementById('totalClasses').textContent = total;
            document.getElementById('publishedCount').textContent = published;
            document.getElementById('unpublishedCount').textContent = unpublished;
        }

        function togglePublication(classId, publish, className) {
            const action = publish ? 'publish' : 'unpublish';
            const message = `Are you sure you want to ${action} results for <strong>${className}</strong>?`;

            document.getElementById('modalMessage').innerHTML = message;
            pendingAction = () => executeToggle(classId, publish);

            document.getElementById('confirmBtn').onclick = function () {
                if (pendingAction) {
                    pendingAction();
                    confirmModal.hide();
                }
            };

            confirmModal.show();
        }

        async function executeToggle(classId, publish) {
            try {
                const response = await fetch(`/results/publish/${classId}?publish=${publish}`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (response.ok) {
                    showNotification(data.message, 'success');
                    loadClasses(); // Reload to update UI
                } else {
                    showNotification('Failed to update publication status', 'error');
                    loadClasses(); // Reload to reset toggle
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('Network error occurred', 'error');
                loadClasses();
            }
        }

        function bulkPublishAll() {
            const message = 'Are you sure you want to <strong>PUBLISH RESULTS FOR ALL CLASSES</strong>? This will make results visible to all students.';

            document.getElementById('modalMessage').innerHTML = message;
            pendingAction = executeBulkPublish;

            document.getElementById('confirmBtn').onclick = function () {
                if (pendingAction) {
                    pendingAction();
                    confirmModal.hide();
                }
            };

            confirmModal.show();
        }

        async function executeBulkPublish() {
            try {
                const response = await fetch('/results/publish-all', {
                    method: 'POST'
                });

                const data = await response.json();

                if (response.ok) {
                    showNotification(data.message, 'success');
                    loadClasses();
                } else {
                    showNotification('Failed to publish all results', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('Network error occurred', 'error');
            }
        }

        function showNotification(message, type) {
            const bgColor = type === 'success' ? '#28a745' : '#dc3545';
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${bgColor};
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                z-index: 9999;
                animation: slideIn 0.3s;
            `;
            notification.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : 'exclamation'}-circle me-2"></i>${message}`;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
    </script>

    <style>
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }

            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
    </style>
</body>

</html>